{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mapa Interativo - Quadras</title>

    <!-- usar CDN do Leaflet para garantir o CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        body, html { height: 100%; margin: 0; font-family: Arial, sans-serif; }
        nav { padding: 10px; background:#0d6efd; color:#fff; }
        main { padding: 10px; }
        #map { width: 100%; height: 72vh; border: 1px solid #ddd; border-radius:6px; }
        .search-bar { display:flex; gap:8px; margin-bottom:10px; align-items:center; }
        .search-bar input[type="search"] { flex:1; padding:8px 10px; border-radius:4px; border:1px solid #ccc; box-sizing: border-box; }
        .search-bar button { padding:8px 12px; border-radius:4px; background:#0d6efd; color:#fff; border:none; cursor:pointer; }
        /* lista de resultados abaixo do mapa ficará oculta — informações só aparecem ao clicar no marcador */
        .results { display:none; }
        .result-item { padding:6px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:8px; }
        .result-item:hover { background:#f7f7f7; }
        .result-left { flex: 1; }
        .result-actions a { text-decoration: none; color: #0d6efd; font-size:0.9rem; }
        .info { color:#666; margin-top:6px; font-size:0.9rem; }
        .access-open { color: #127a13; font-weight:600; }
        .access-closed { color: #b02a37; font-weight:600; }
        .access-unknown { color: #6c757d; font-weight:600; }
    </style>
</head>
<body>
    <nav>ConectaEsporte — Mapa de Quadras</nav>
    <main>
        <h1>Procure quadras públicas</h1>

        <div class="search-bar" role="search" aria-label="Busca de quadras">
            <input id="query" type="search" placeholder="Ex.: quadras de tênis, futsal perto de mim, quadras públicas" />
            <button id="searchBtn">Pesquisar</button>
            <button id="clearBtn" title="Limpar resultados" style="background:#6c757d">Limpar</button>
        </div>
        <div class="info">Dica: posicione o mapa na área desejada antes de pesquisar — a busca usa os limites visíveis.</div>
        <div id="map" aria-label="Mapa do Brasil interativo"></div>
        <div class="results" id="results"></div> <!-- mantido oculto para compatibilidade -->
    </main>
    <footer>Busca via Overpass API (OpenStreetMap). Resultados públicos.</footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const OVERPASS_ENDPOINTS = [
            'https://overpass-api.de/api/interpreter',
            'https://lz4.overpass-api.de/api/interpreter',
            'https://overpass.openstreetmap.ru/api/interpreter',
            'https://overpass.kumi.systems/api/interpreter'
        ];

        const brasilCenter = [-14.2350, -51.9253];
        const map = L.map('map', { zoomControl: true }).setView(brasilCenter, 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.control.scale().addTo(map);

        const markerLayer = L.layerGroup().addTo(map);

        const queryEl = document.getElementById('query');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultsEl = document.getElementById('results'); // mantido, mas não será usado para listar

        function parseQueryToFilters(q) {
            const text = (q || '').toLowerCase();
            const filters = [];
            const sportMap = [
                { keys: ['tênis', 'tenis'], value: 'tennis' },
                { keys: ['basquete', 'basquetebol', 'basket'], value: 'basketball' },
                { keys: ['futebol', 'futsal', 'soccer', 'football'], value: 'football' },
                { keys: ['voleibol', 'volei'], value: 'volleyball' }
            ];
            let detectedSport = null;
            for (const m of sportMap) if (m.keys.some(k => text.includes(k))) { detectedSport = m.value; break; }

            if (detectedSport) {
                filters.push(`["leisure"="pitch"]["sport"="${detectedSport}"]`);
                filters.push(`["amenity"="sports_centre"]["sport"="${detectedSport}"]`);
                filters.push(`["sport"="${detectedSport}"]`);
            } else {
                filters.push(`["leisure"="pitch"]`);
                filters.push(`["amenity"="sports_centre"]`);
            }
            return filters;
        }

        function buildOverpassQL(filters, bbox) {
            let blocks = '';
            filters.forEach(f => {
                blocks += `node${f}(${bbox});\n`;
                blocks += `way${f}(${bbox});\n`;
                blocks += `relation${f}(${bbox});\n`;
            });
            return `[out:json][timeout:25];
(
${blocks}
);
out center;`;
        }

        function buildOverpassQLAround(filters, lat, lon, radius) {
            let blocks = '';
            filters.forEach(f => {
                blocks += `node${f}(around:${radius},${lat},${lon});\n`;
                blocks += `way${f}(around:${radius},${lat},${lon});\n`;
                blocks += `relation${f}(around:${radius},${lat},${lon});\n`;
            });
            return `[out:json][timeout:25];
(
${blocks}
);
out center;`;
        }

        function humanizeSport(s) {
            if (!s) return '';
            const k = s.toLowerCase();
            const map = { 'tennis': 'Tênis', 'football': 'Futebol', 'futsal': 'Futsal', 'basketball': 'Basquete', 'volleyball': 'Voleibol', 'soccer': 'Futebol' };
            return map[k] || s.charAt(0).toUpperCase() + s.slice(1);
        }

        function humanizeLeisure(l) {
            if (!l) return '';
            const k = l.toLowerCase();
            const map = { 'pitch': 'Quadra / Campo', 'sports_centre': 'Centro Esportivo', 'stadium': 'Estádio' };
            return map[k] || l;
        }

        function ensureUrlProtocol(u) {
            if (!u) return null;
            if (/^https?:\/\//i.test(u)) return u;
            return 'https://' + u;
        }

        function buildInfoUrl(tags, el) {
            if (!tags) tags = {};
            const site = tags.website || tags.url || tags['contact:website'];
            if (site) return ensureUrlProtocol(site);
            if (tags.wikipedia) {
                const parts = tags.wikipedia.split(':');
                if (parts.length >= 2) {
                    const lang = parts.shift();
                    const page = parts.join(':');
                    return `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(page)}`;
                } else {
                    return `https://pt.wikipedia.org/wiki/${encodeURIComponent(tags.wikipedia)}`;
                }
            }
            if (el && el.type && el.id) return `https://www.openstreetmap.org/${el.type}/${el.id}`;
            return null;
        }

        function getOwnerLabel(tags) {
            if (!tags) return null;
            const keys = ['operator', 'owner', 'operator:owner', 'contact:owner', 'contact:website', 'owner:official'];
            for (const k of keys) if (tags[k]) return String(tags[k]).trim();
            return null;
        }

        function determineAccess(tags) {
            if (!tags) return { label: 'Desconhecido', css: 'access-unknown' };
            const access = (tags.access || tags['access:conditional'] || '').toLowerCase();
            if (access.includes('yes') || access.includes('public') || access.includes('open')) return { label: 'Público', css: 'access-open' };
            if (access.includes('no') || access.includes('private') || access.includes('restricted')) return { label: 'Privado/Restrito', css: 'access-closed' };
            const fee = (tags.fee || tags['fee'] || tags.charge || '').toLowerCase();
            if (fee && (fee.includes('yes') || fee.includes('paid') || fee.includes('ticket'))) return { label: 'Privado / Pago', css: 'access-closed' };
            const landuse = (tags.landuse || '').toLowerCase();
            if (['school', 'college', 'university', 'education'].includes(landuse)) return { label: 'Restrito (uso escolar)', css: 'access-closed' };
            const operator = (tags.operator || '').toLowerCase();
            const publicKeywords = ['prefeitura', 'municipal', 'município', 'cidade', 'secretaria', 'governo', 'city', 'municipalidad', 'department', 'pref'];
            if (publicKeywords.some(k => operator.includes(k))) return { label: 'Público', css: 'access-open' };
            const owner = (tags.owner || tags['operator:owner'] || '').toLowerCase();
            if (owner.includes('priv') || owner.includes('particular') || owner.includes('private')) return { label: 'Privado', css: 'access-closed' };
            const amen = (tags.amenity || '').toLowerCase();
            const leisure = (tags.leisure || '').toLowerCase();
            if (amen === 'park' || leisure === 'park' || amen === 'playground' || leisure === 'playground') return { label: 'Público', css: 'access-open' };
            if (tags.website || tags.phone || tags['contact:website']) return { label: 'Público (verificar)', css: 'access-open' };
            return { label: 'Desconhecido', css: 'access-unknown' };
        }

        async function tryPostOverpass(endpoint, body) {
            const res = await fetch(endpoint, {
                method: 'POST',
                body,
                headers: { 'Content-Type': 'text/plain' }
            });
            return res;
        }

        async function searchQuadras(queryText) {
            markerLayer.clearLayers();
            // status agora só em console / alert, não em lista visível
            console.log('Buscando quadras para:', queryText);

            const bounds = map.getBounds();
            let s = bounds.getSouth(), w = bounds.getWest(), n = bounds.getNorth(), e = bounds.getEast();
            let bbox = `${s},${w},${n},${e}`;

            const filters = parseQueryToFilters(queryText);
            let q = buildOverpassQL(filters, bbox);

            let lastError = null;
            const maxRetries = 3;
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                const endpoint = OVERPASS_ENDPOINTS[attempt % OVERPASS_ENDPOINTS.length];
                try {
                    const res = await tryPostOverpass(endpoint, q);
                    if (res.status === 504 || res.status === 502 || res.status === 522) {
                        lastError = new Error(`Overpass retornou ${res.status}`);
                        if (attempt < maxRetries) {
                            const shrinkFactor = 0.6 ** (attempt + 1);
                            const center = map.getCenter();
                            const latSpan = (n - s) * shrinkFactor / 2;
                            const lonSpan = (e - w) * shrinkFactor / 2;
                            s = center.lat - latSpan; n = center.lat + latSpan; w = center.lng - lonSpan; e = center.lng + lonSpan;
                            bbox = `${s},${w},${n},${e}`;
                            q = buildOverpassQL(filters, bbox);
                            continue;
                        }
                    } else if (!res.ok) {
                        lastError = new Error('Overpass retornou ' + res.status);
                    } else {
                        const data = await res.json();
                        renderOverpassResults(data);
                        return;
                    }
                } catch (err) {
                    lastError = err;
                    if (attempt < maxRetries) continue;
                }
            }

            // fallback: busca por raio progressivo no centro do mapa
            const center = map.getCenter();
            const radii = [2000, 5000, 10000];
            for (const r of radii) {
                for (const endpoint of OVERPASS_ENDPOINTS) {
                    try {
                        const q2 = buildOverpassQLAround(filters, center.lat, center.lng, r);
                        const res2 = await tryPostOverpass(endpoint, q2);
                        if (!res2.ok) continue;
                        const data2 = await res2.json();
                        if ((data2.elements || []).length > 0) {
                            renderOverpassResults(data2);
                            return;
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }

            console.error('Busca falhou:', lastError);
            alert('Erro na busca: ' + (lastError ? lastError.message : 'timeout') + '. Tente reduzir a área visível ou centralizar o mapa e pesquisar novamente.');
        }

        // renderização dos resultados — apenas cria marcadores; sem lista abaixo do mapa
        function renderOverpassResults(data) {
            markerLayer.clearLayers();
            const elements = data.elements || [];
            if (elements.length === 0) {
                alert('Nenhuma quadra encontrada na área visível.');
                return;
            }

            elements.forEach((el) => {
                let lat, lon;
                if (el.type === 'node') { lat = el.lat; lon = el.lon; }
                else if ((el.type === 'way' || el.type === 'relation') && el.center) { lat = el.center.lat; lon = el.center.lon; }
                if (lat == null || lon == null) return;

                const tags = el.tags || {};
                const preferredName = tags['name:pt'] || tags.name || tags.ref || (tags['addr:street'] ? (tags['addr:street'] + (tags['addr:housenumber'] ? ' ' + tags['addr:housenumber'] : '')) : null);

                let title;
                if (preferredName) title = preferredName;
                else if (tags.sport) title = humanizeSport(tags.sport) + (tags.leisure ? ' — ' + humanizeLeisure(tags.leisure) : '');
                else if (tags.leisure) title = humanizeLeisure(tags.leisure);
                else title = 'Quadra pública';

                const popupParts = [];
                popupParts.push(`<strong>${escapeHtml(title)}</strong>`);
                if (tags.sport) popupParts.push('Esporte: ' + escapeHtml(humanizeSport(tags.sport)));
                if (tags.leisure) popupParts.push('Tipo: ' + escapeHtml(humanizeLeisure(tags.leisure)));
                if (tags.operator) popupParts.push('Operador: ' + escapeHtml(tags.operator));
                if (tags['addr:street']) popupParts.push('Endereço: ' + escapeHtml(tags['addr:street'] + (tags['addr:housenumber'] ? ', ' + tags['addr:housenumber'] : '')));
                if (tags.phone) popupParts.push('Telefone: ' + escapeHtml(tags.phone));
                if (tags.opening_hours) popupParts.push('Horário: ' + escapeHtml(tags.opening_hours));

                const ownerLabel = getOwnerLabel(tags);
                if (ownerLabel) popupParts.push('Dono/Operador: ' + escapeHtml(ownerLabel));
                else {
                    const accessInfo = determineAccess(tags);
                    popupParts.push(`<span class="${accessInfo.css}">Acesso: ${escapeHtml(accessInfo.label)}</span>`);
                }

                const infoUrl = buildInfoUrl(tags, el);
                if (infoUrl) popupParts.push(`<a href="${escapeHtml(infoUrl)}" target="_blank" rel="noopener noreferrer">Mais informações</a>`);
                else popupParts.push('<small>Fonte: OpenStreetMap</small>');

                const marker = L.marker([lat, lon]).addTo(markerLayer);
                marker.bindPopup(popupParts.join('<br>'));
                // informação só aparece quando o usuário clica no marcador (popup)
            });
        }

        function escapeHtml(s) {
            if (s == null) return '';
            return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
        }

        searchBtn.addEventListener('click', function () { searchQuadras(queryEl.value); });

        queryEl.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') { e.preventDefault(); searchQuadras(queryEl.value); }
        });

        clearBtn.addEventListener('click', function () { markerLayer.clearLayers(); queryEl.value = ''; });

        map.on('click', function (e) {
            L.popup().setLatLng(e.latlng).setContent(`Coordenadas: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`).openOn(map);
        });
    });
    </script>
</body>
</html>